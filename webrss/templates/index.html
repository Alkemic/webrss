<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>WebRSS</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="//netdna.bootstrapcdn.com/bootstrap/latest/css/bootstrap.min.css" rel="stylesheet" />
    <link href="//netdna.bootstrapcdn.com/bootstrap/latest/css/bootstrap-theme.min.css" rel="stylesheet" />
    <link href="{{ url_for('static', filename='default.css') }}" rel="stylesheet" />

    <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/respond.js/1.4.2/respond.js"></script>
    <![endif]-->

    <script src="//code.jquery.com/jquery-2.1.0.min.js"></script>
    <script src="//netdna.bootstrapcdn.com/bootstrap/latest/js/bootstrap.min.js"></script>

    {% if google_site_verification %}<meta name="google-site-verification" content="{{ google_site_verification }}" />{% endif %}
</head>
<body>

    <div id="wrap">
        <header class="navbar navbar-inverse navbar-fixed-top" role="navigation">
            <div class="container">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="/">WebRSS</a>
                </div>
                <div class="collapse navbar-collapse">
                    <ul class="nav navbar-nav">
                        <!--<li><a href="/">Add</a></li>-->

                        <li><button class="btn btn-primary btn-sl" data-toggle="modal" data-target="#add-category"><i class="glyphicon glyphicon-plus"></i> Add category</button></li>
                        <li><button class="btn btn-primary btn-sl" data-toggle="modal" data-target="#add-feed"><i class="glyphicon glyphicon-plus"></i> Add feed</button></li>
                    </ul>
                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <form class="navbar-form navbar-left search" role="search">
                                <div class="form-group"><input name="phrase" type="text" class="form-control" placeholder="Search" /></div>
                            </form>
                        </li>
                    </ul>
                </div>
            </div>
        </header>

        <div class="row" id="rss">
            <div class="col-md-3" id="channels">
                {% for category in categories %}
                <h4>
                    {{ category.title }}
                    <!--<span class="pull-right">-->
                        <!--<div class="dropdown">-->
                            <!--<a data-toggle="dropdown" href="#" class="glyphicon glyphicon-cog" data-category-id="{{ category.id }}"></a>-->
                            <!--<ul class="dropdown-menu" role="menu" aria-labelledby="dLabel">-->
                                <!--<li><i class="glyphicon glyphicon-plus" data-category-id="{{ category.id }}"></i> Add in this category</li>-->
                            <!--</ul>-->
                        <!--</div>-->
                    <!--</span>-->

                    <span class="pull-right">
                        <!--<i href="#" class="glyphicon glyphicon-trash pointer" data-category-id="{{ category.id }}" title="Delete this category"></i>-->
                        <i class="glyphicon glyphicon-plus pointer" data-category-id="{{ category.id }}" title="Add feed in this category"></i>
                    </span>
                </h4>
                <ul class="nav nav-pills nav-stacked resource-list">
                    {% for feed in category.not_deleted_feeds() %}
                    <li class="feed">
                        <a href="#" class="feed-link" data-feed-id="{{ feed.id }}"><img class="favicon-url" src="{{ feed.site_favicon_url }}">
                            <span class="feed-title">{{ feed.feed_title }}</span>
                            <span class="pull-right">
                                <span class="badge">{{ feed.count_un_read() }}</span>
                                &nbsp;<i class="glyphicon glyphicon-trash pointer" data-feed-id="{{ feed.id }}" title="Delete this feed"></i>
                                <!--&nbsp;&nbsp; <i class="glyphicon glyphicon-edit"></i>-->
                            </span>
                        </a>
                    </li>
                    {% endfor %}
                </ul>
                {% endfor %}
            </div>
            <div class="col-md-9" id="feeds">
                <div id="list">
                    <!--//-->
                </div>
                <div id="content">
                    <!--//-->
                </div>
            </div>
        </div>

        <footer id="footer">&copy; 2014 <a href="http://danielczuba.pl">Daniel Czuba</a></footer>

    </div><!-- /#wrap -->

    {% include 'category/add_form.html' with context %}
    {% include 'feed/add_form.html' with context %}

    <script>
        $(document).ready(function(){
            var div_channels = $('div#channels'),
                entries_list = $('#feeds div#list'),
                entry_content = $('#feeds div#content'),
                feed_row = $('tbody tr', entries_list),
                feed_delete_modal = $('div#delete-feed'),
                feed_delete_modal_submit = $('button[type=submit]', feed_delete_modal)

            // deleting a feed
            $('li.feed i[data-feed-id].glyphicon-trash', div_channels).click(function(e){
                e.preventDefault();
                e.stopPropagation();
                var self = $(this),
                    feed_id = self.data('feed-id');

                feed_delete_modal.modal();
                feed_delete_modal_submit.data('feed-id', feed_id);
                $('span.item-to-delete-name', feed_delete_modal).html($('a.feed-link[data-feed-id='+feed_id+'] span.feed-title').html());
            });

            feed_delete_modal_submit.click(function(e){
                e.preventDefault();
                var self = $(this),
                    feed_id = self.data('feed-id');

                $.post("{{ url_for('feed.delete') }}", {pk: feed_id}, function(result){
                    if(result.status == 'ok'){
                        location.reload(true);
                    }else{
                        alert(result.message);
                    }
                });
            });

            //
            $('#channels ul li a').click(function(e){
                e.preventDefault();
                var feed_id = $(this).data('feed-id');
                $.post("{{ url_for('feed.index') }}", {feed_id: feed_id}, function(res){
                    entries_list.html(res);
                });
            });

            // reading new feed
            entries_list.on('click', 'tr[data-entry-id]', function(e){
                e.preventDefault();

                var self = $(this),
                    entry_id = self.data('entry-id'),
                    entry_feed_id = self.data('feed-id');

                $.post("{{ url_for('entry.fetch') }}", {pk: entry_id}, function(content){
                    entry_content.html(content);
                    if(self.hasClass('bold')){
                        var feed_badge = $('a[data-feed-id='+entry_feed_id+'].feed-link span.badge');
                        feed_badge.html(feed_badge.html()-1);
                        self.removeClass('bold');
                    }
                });
            });

            // adding new feed from category
            $('h4 .glyphicon-plus', div_channels).click(function(e){
                e.preventDefault();
                var self = $(this),
                    category_id = self.data('category-id');

                $('div#add-feed select#category').val(category_id);
                $('#add-feed').modal();
            });

        });
    </script>

    <div class="modal fade" id="delete-feed" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                    <h4 class="modal-title">Confirm deletion</h4>
                </div>
                <div class="modal-body">
                    <p>Do you want to delete "<span class="item-to-delete-name"></span>"?</p>
                </div>
                <div class="modal-footer">
                    <button type="reset" class="btn btn-default" data-dismiss="modal"><i class="glyphicon glyphicon-remove"></i> Close</button>
                    <button type="submit" class="btn btn-primary"><i class="glyphicon glyphicon-trash"></i> Delete</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>

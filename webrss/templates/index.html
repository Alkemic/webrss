<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>WebRSS</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="//netdna.bootstrapcdn.com/bootstrap/latest/css/bootstrap.min.css" rel="stylesheet" />
    <link href="//netdna.bootstrapcdn.com/bootstrap/latest/css/bootstrap-theme.min.css" rel="stylesheet" />
    <link href="{{ url_for('static', filename='default.css') }}" rel="stylesheet" />
    <script>
        var webrss = webrss || {};
        webrss.url = webrss.url || {};

        webrss.url.feed_index = "{{ url_for('feed.index') }}";
        webrss.url.feed_create = "{{ url_for('feed.create') }}";
        webrss.url.feed_update = "{{ url_for('feed.update') }}";
        webrss.url.feed_delete = "{{ url_for('feed.delete') }}";

        webrss.url.category_index = "{{ url_for('category.index') }}";
        webrss.url.category_create = "{{ url_for('category.create') }}";
        webrss.url.category_update = "{{ url_for('category.update') }}";
        webrss.url.category_delete = "{{ url_for('category.delete') }}";
        webrss.url.category_move_up = "{{ url_for('category.move_up') }}";
        webrss.url.category_move_down = "{{ url_for('category.move_down') }}";

        webrss.url.entry_fetch = "{{ url_for('entry.fetch') }}";

        webrss.url.search = "{{ url_for('search') }}";
    </script>
    <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/respond.js/1.4.2/respond.js"></script>
    <![endif]-->

    <script src="//code.jquery.com/jquery-2.1.0.min.js"></script>
    <script src="//netdna.bootstrapcdn.com/bootstrap/latest/js/bootstrap.min.js"></script>

    {% if google_site_verification %}<meta name="google-site-verification" content="{{ google_site_verification }}" />{% endif %}
</head>
<body>

    <div id="wrap">
        <header class="navbar navbar-inverse navbar-fixed-top" role="navigation">
            <div class="container">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="/">WebRSS</a>
                </div>
                <div class="collapse navbar-collapse">
                    <ul class="nav navbar-nav">
                        <li><button class="btn btn-primary btn-sm" id="category-form-create"><i class="glyphicon glyphicon-plus"></i> Add category</button></li>
                        <li><button class="btn btn-primary btn-sm" id="feed-form-create"><i class="glyphicon glyphicon-plus"></i> Add feed</button></li>
                    </ul>
                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <form class="navbar-form navbar-left search" role="search" id="search">
                                <div class="form-group"><input name="phrase" type="text" class="form-control input-sm" placeholder="Search" required /></div>
                            </form>
                        </li>
                    </ul>
                </div>
            </div>
        </header>

        <div class="row" id="rss">
            <div class="col-md-3" id="channels">
                {% for category in categories %}
                <h4 data-category-id="{{ category.id }}" title="{{ category.title }}">
                    {{ category.title }}
                    <span class="pull-right">
                        <i class="glyphicon glyphicon-arrow-up pointer" data-category-id="{{ category.id }}" title="Move this category up"></i>
                        <i class="glyphicon glyphicon-arrow-down pointer" data-category-id="{{ category.id }}" title="Move this category down"></i>
                        <i class="glyphicon glyphicon-plus pointer" data-category-id="{{ category.id }}" title="Add feed in this category"></i>
                        <i class="glyphicon glyphicon-edit pointer" data-category-id="{{ category.id }}" title="Edit this category"></i>
                        <i class="glyphicon glyphicon-trash pointer" data-category-id="{{ category.id }}" title="Delete this category"></i>
                    </span>
                </h4>
                <ul class="nav nav-pills nav-stacked resource-list">
                    {% for feed in category.not_deleted_feeds() %}
                    <li class="feed" data-feed-id="{{ feed.id }}">
                        <a data-feed-id="{{ feed.id }}"><img class="favicon-url" src="{{ feed.site_favicon_url }}">
                            <span class="feed-title">{{ feed.feed_title }}</span>
                            <span class="pull-right">
                                <span class="badge">{{ feed.count_un_read() }}</span>
                                &nbsp;<i class="glyphicon glyphicon-trash pointer" data-feed-id="{{ feed.id }}" title="Delete this feed"></i>
                                &nbsp;<i class="glyphicon glyphicon-edit pointer" data-feed-id="{{ feed.id }}" title="Edit this feed"></i>
                            </span>
                        </a>
                    </li>
                    {% endfor %}
                </ul>
                {% endfor %}
            </div>
            <div class="col-md-9" id="feeds">
                <div id="list">
                    <!--//-->
                </div>
                <div id="content">
                    <!--//-->
                </div>
            </div>
        </div>

        <footer id="footer">&copy; 2014 <a href="http://danielczuba.pl" title="Daniel Alkemic Czuba">Daniel Czuba</a></footer>

    </div><!-- /#wrap -->

    {% include 'category/forms.html' with context %}
    {% include 'feed/forms.html' with context %}

    <script>
        $(document).ready(function(){
            var div_channels = $('div#channels'),
                entries_list = $('#feeds div#list'),
                entry_content = $('#feeds div#content'),
                feed_row = $('tbody tr', entries_list),
                feeds_list = $('ul li', div_channels),
                search_form = $('form#search');

            // loading feed content
            feeds_list.click(function(e){
                e.preventDefault();
                var self = $(this),
                    feed_id = self.data('feed-id');

                feeds_list.removeClass('active');
                self.addClass('active');

                $.post(webrss.url.feed_index, {feed_id: feed_id}, function(res){
                    entries_list.html(res);
                });
            });

            // reading single feed
            entries_list.on('click', 'tr[data-entry-id]', function(e){
                e.preventDefault();

                var self = $(this),
                    entry_id = self.data('entry-id'),
                    entry_feed_id = self.data('feed-id');

                $('tr[data-entry-id]', entries_list).removeClass('info');
                self.addClass('info');

                $.post(webrss.url.entry_fetch, {pk: entry_id}, function(content){
                    entry_content.html(content);
                    if(self.hasClass('bold')){
                        var feed_badge = $('a[data-feed-id='+entry_feed_id+'].feed-link span.badge');
                        feed_badge.html(feed_badge.html()-1);
                        self.removeClass('bold');
                    }
                });
            });

            // submiting search form
            search_form.submit(function(e){
                e.preventDefault();

                var self = $(this),
                    form_data = self.serialize();

                $.post(
                    webrss.url.search,
                    form_data,
                    function(result){
                        console.log(result);
                        entries_list.html(result);
                    }
                );

            });

        });
    </script>

</body>
</html>

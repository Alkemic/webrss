sudo: required

language: python

services:
  - docker

before_install:
  - docker --version

script:
  - docker build -t alkemic/webrss .

after_success:
  - |
    if [ "$TRAVIS_TAG" != "" ] || [ "$TRAVIS_BRANCH" == "master" ]
    then
      docker login -u=alkemic -p="${PASSWORD}"
      docker push alkemic/webrss

      if [ "$TRAVIS_TAG" != "" ] && [[ $TRAVIS_TAG =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]
      then
        revs=( ${TRAVIS_TAG//./ } )

        docker tag alkemic/webrss:latest TARGET_IMAGE:${revs[0]}.${revs[1]}.${revs[2]}
        docker tag alkemic/webrss:latest TARGET_IMAGE:${revs[0]}.${revs[1]}
        docker tag alkemic/webrss:latest TARGET_IMAGE:${revs[0]}

        docker push alkemic/webrss:${revs[0]}.${revs[1]}.${revs[2]}
        docker push alkemic/webrss:${revs[0]}.${revs[1]}
        docker push alkemic/webrss:${revs[0]}
      fi
    fi

env:
  global:
    secure: "ExeGeq4EAn0aVGxRCxhAT+PKvc1hKEvBHA+70R3SeP1mnroK/PBJ9L7YnkpgVoOJ5B18h+svRajCf0eVrp37yMCoIi+4bhr7bqkMAtQC7OJjjpN6EZKJu2mHUUHYHiKB9f5DEQFkSnDgKOm2DlA/47h4u7DXLbQqK/3oAJ7OPnQ="
